# Оптимизация производительности и кэширование

## Что было сделано для ускорения проекта

### 1. Логирование медленных запросов

- Добавлено логирование всех запросов, которые выполняются дольше 500мс
- Логи отображаются как `[SLOW REQUEST]` в консоли

### 2. Ограничение limit/offset

- Максимальный `limit` ограничен до 100 элементов
- Максимальный `offset` ограничен до 10 000
- Защита от слишком тяжёлых запросов

### 3. Индексы базы данных

- Применены все необходимые индексы для ускорения запросов
- Индексы созданы для таблиц: `recipes`, `recipe_ingredients`, `saved_recipes`, теги

### 4. Redis кэширование

#### Настроено кэширование для:

- **Рецепты** (`getRecipes`) - TTL 7 дней
- **Поиск рецептов** (`searchRecipes`) - TTL 7 дней
- **Отдельные рецепты** (`getRecipeById`) - TTL 7 дней
- **Теги** (`getAllTags`) - TTL 7 дней
- **Категории ингредиентов** (`getCategories`) - TTL 7 дней
- **Группированные ингредиенты** (`getGroupedIngredients`) - TTL 7 дней
- **Избранные рецепты** (`getUserSavedRecipes`) - TTL 1 час

#### Ключи кэша:

- `recipes:{параметры_запроса}` - для списков рецептов
- `recipes:search:{параметры_поиска}` - для поиска
- `recipe:{id}:{ingredientIds}` - для отдельных рецептов
- `tags:all` - для всех тегов
- `categories:{language}` - для категорий
- `grouped_ingredients:{language}` - для группированных ингредиентов
- `saved_recipes:{userId}` - для избранных рецептов

### 5. Инвалидация кэша

- При сохранении/удалении рецепта из избранного кэш автоматически очищается
- Административные команды для ручной очистки кэша

## Использование

### Запуск с Redis

```bash
# Установить Redis (если не установлен)
# На Windows: скачать с https://redis.io/download
# На Linux/Mac: brew install redis или apt-get install redis-server

# Запустить Redis
redis-server

# В .env файле указать URL Redis (опционально)
REDIS_URL=redis://localhost:6379
```

### Административные команды для управления кэшем

#### Получить статистику кэша:

```
GET /api/admin/cache?action=stats
```

#### Очистить кэш рецептов:

```
GET /api/admin/cache?action=clear-recipes
```

#### Очистить кэш ингредиентов:

```
GET /api/admin/cache?action=clear-ingredients
```

#### Очистить кэш тегов:

```
GET /api/admin/cache?action=clear-tags
```

#### Очистить весь кэш:

```
GET /api/admin/cache?action=clear-all
```

## Производительность

### Ожидаемые улучшения:

- **Повторные запросы**: мгновенный ответ из кэша
- **Снижение нагрузки на БД**: до 90% для кэшированных данных
- **Ускорение поиска**: особенно для популярных запросов
- **Стабильная работа**: защита от слишком тяжёлых запросов

### Мониторинг:

- Логирование медленных запросов (>500мс)
- Статистика использования кэша через `/api/admin/cache?action=stats`

## Настройка TTL

Если нужно изменить время жизни кэша:

```typescript
// В src/controllers/recipeController.ts
await cache.setex(cacheKey, 604800, JSON.stringify(response)); // 7 дней
// Изменить на:
await cache.setex(cacheKey, 2592000, JSON.stringify(response)); // 30 дней
```

## Troubleshooting

### Если Redis недоступен:

- Приложение продолжит работать без кэша
- Все запросы будут выполняться напрямую к базе данных
- В логах будут ошибки подключения к Redis

### Если кэш не работает:

1. Проверить подключение к Redis: `redis-cli ping`
2. Проверить логи на ошибки Redis
3. Очистить кэш: `/api/admin/cache?action=clear-all`

### Если данные устарели:

- Очистить соответствующий кэш через административные команды
- Или дождаться автоматического истечения TTL
